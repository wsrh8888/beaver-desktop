# æ¶ˆæ¯æ¥æ”¶å™¨æ¶æ„

## ğŸ“ ç›®å½•ç»“æ„

```
receivers/
â”œâ”€â”€ chat/
â”‚   â”œâ”€â”€ receiver.ts        # èŠå¤©æ¶ˆæ¯æ¥æ”¶å™¨ï¼ˆä¸»å…¥å£ï¼‰
â”‚   â”œâ”€â”€ types.ts           # èŠå¤©æ¶ˆæ¯ç±»å‹å®šä¹‰
â”‚   â””â”€â”€ handlers/
â”‚       â”œâ”€â”€ common.ts      # é€šç”¨å¤„ç†é€»è¾‘
â”‚       â”œâ”€â”€ private-message.ts  # ç§èŠæ¶ˆæ¯å¤„ç†å™¨
â”‚       â””â”€â”€ group-message.ts    # ç¾¤èŠæ¶ˆæ¯å¤„ç†å™¨
â”œâ”€â”€ conversation/
â”‚   â””â”€â”€ receiver.ts        # ä¼šè¯æ“ä½œæ¥æ”¶å™¨
â”œâ”€â”€ user/
â”‚   â””â”€â”€ receiver.ts        # ç”¨æˆ·èµ„æ–™æ¥æ”¶å™¨
â”œâ”€â”€ friend/
â”‚   â””â”€â”€ receiver.ts        # å¥½å‹æ“ä½œæ¥æ”¶å™¨
â””â”€â”€ group/
    â””â”€â”€ receiver.ts        # ç¾¤ç»„æ“ä½œæ¥æ”¶å™¨
```

## ğŸ¯ è®¾è®¡ç†å¿µ

**åˆ†å±‚æ¶æ„** - å€Ÿé‰´beaver-serverçš„è®¾è®¡ï¼ŒæŒ‰æ¶ˆæ¯ç±»å‹å’Œå¤„ç†é€»è¾‘åˆ†å±‚ï¼š

1. **æ¶ˆæ¯ç±»å‹å±‚** - æŒ‰ä¸šåŠ¡é¢†åŸŸåˆ†ç»„ï¼ˆchat/, user/, friend/ç­‰ï¼‰
2. **å¤„ç†å™¨å±‚** - é’ˆå¯¹ä¸åŒæ¶ˆæ¯ç±»å‹çš„ä¸“é—¨å¤„ç†å™¨
3. **é€šç”¨å±‚** - å…±äº«çš„å¤„ç†é€»è¾‘å’Œå·¥å…·å‡½æ•°

## ğŸ—ï¸ chat/ æ¨¡å—è¯¦è§£

### receiver.ts - ä¸»å…¥å£
```typescript
export class ChatReceiver extends BaseReceiver<ChatMessageData> {
  // è·¯ç”±ä¸åŒç±»å‹çš„æ¶ˆæ¯åˆ°å¯¹åº”çš„å¤„ç†å™¨
  async handle(wsMessage: any) {
    switch (data?.type) {
      case 'private_message_receive':
        // è°ƒç”¨ç§èŠå¤„ç†å™¨
      case 'group_message_receive':
        // è°ƒç”¨ç¾¤èŠå¤„ç†å™¨
    }
  }
}
```

### handlers/ - å¤„ç†å™¨ç›®å½•

#### common.ts - é€šç”¨å¤„ç†å™¨
- `parseMessageType()` - è§£ææ¶ˆæ¯ç±»å‹
- `extractMessagePreview()` - æå–æ¶ˆæ¯é¢„è§ˆ
- `processSingleMessage()` - å•æ¡æ¶ˆæ¯å¤„ç†
- `processBatchMessages()` - æ‰¹é‡æ¶ˆæ¯å¤„ç†

#### private-message.ts - ç§èŠå¤„ç†å™¨
- `processMessage()` - å¤„ç†å•æ¡ç§èŠæ¶ˆæ¯
- `processBatchMessages()` - æ‰¹é‡å¤„ç†ç§èŠæ¶ˆæ¯
- `validateMessage()` - éªŒè¯ç§èŠæ¶ˆæ¯

#### group-message.ts - ç¾¤èŠå¤„ç†å™¨
- `processMessage()` - å¤„ç†å•æ¡ç¾¤èŠæ¶ˆæ¯
- `processBatchMessages()` - æ‰¹é‡å¤„ç†ç¾¤èŠæ¶ˆæ¯
- `validateMessage()` - éªŒè¯ç¾¤èŠæ¶ˆæ¯
- `getGroupMembers()` - è·å–ç¾¤æˆå‘˜
- `isUserInGroup()` - æ£€æŸ¥ç”¨æˆ·æ˜¯å¦åœ¨ç¾¤ä¸­

## ğŸ”„ å¤„ç†æµç¨‹

```
WebSocketæ¶ˆæ¯ â†’ ChatReceiver.handle() â†’ æŒ‰ç±»å‹è·¯ç”±
                                       â†“
                       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                       â”‚ Private     â”‚ Group       â”‚
                       â”‚ Message     â”‚ Message     â”‚
                       â”‚ Handler     â”‚ Handler     â”‚
                       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“             â†“
                       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                       â”‚ Common      â”‚ Common      â”‚
                       â”‚ Handler     â”‚ Handler     â”‚
                       â”‚ (Database   â”‚ (Database   â”‚
                       â”‚  Operations)â”‚  Operations)â”‚
                       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“             â†“
                       æ‰¹é‡æ’å…¥æ¶ˆæ¯ â†â”€â”€â”€â”€â”€â†’ æ›´æ–°ä¼šè¯
```

## ğŸ’¡ ä¼˜åŠ¿

### 1. èŒè´£åˆ†ç¦»
- **receiver.ts**: è·¯ç”±å’Œåè°ƒ
- **handlers/**: å…·ä½“çš„ä¸šåŠ¡å¤„ç†
- **common.ts**: å…±äº«çš„å·¥å…·å‡½æ•°

### 2. æ˜“äºæ‰©å±•
- æ–°å¢æ¶ˆæ¯ç±»å‹ï¼šæ·»åŠ æ–°çš„å¤„ç†å™¨æ–‡ä»¶
- ä¿®æ”¹å¤„ç†é€»è¾‘ï¼šåªæ”¹å¯¹åº”çš„å¤„ç†å™¨
- æ·»åŠ æ–°åŠŸèƒ½ï¼šåœ¨common.tsä¸­æ‰©å±•

### 3. ä¾¿äºæµ‹è¯•
- å¯ä»¥ç‹¬ç«‹æµ‹è¯•æ¯ä¸ªå¤„ç†å™¨
- æ¨¡æ‹Ÿä¸åŒçš„æ¶ˆæ¯ç±»å‹
- éªŒè¯æ‰¹é‡å¤„ç†é€»è¾‘

### 4. ä»£ç å¤ç”¨
- é€šç”¨é€»è¾‘é›†ä¸­åœ¨common.ts
- é¿å…é‡å¤ä»£ç 
- ç»Ÿä¸€çš„æ•°æ®è½¬æ¢å’ŒéªŒè¯

## ğŸš€ æ‰©å±•æŒ‡å—

### æ·»åŠ æ–°çš„æ¶ˆæ¯å¤„ç†å™¨

1. **åœ¨handlers/åˆ›å»ºæ–°å¤„ç†å™¨**
```typescript
// handlers/new-message-type.ts
export class NewMessageTypeHandler {
  static async processMessage(message: NewMessageData): Promise<Result> {
    // å¤„ç†é€»è¾‘
  }
}
```

2. **åœ¨receiver.tsä¸­æ·»åŠ è·¯ç”±**
```typescript
case 'new_message_type':
  // è°ƒç”¨æ–°çš„å¤„ç†å™¨
  break
```

3. **æ›´æ–°ç±»å‹å®šä¹‰**
```typescript
// types.ts
export interface NewMessageData {
  // æ–°æ¶ˆæ¯ç±»å‹å®šä¹‰
}
```

è¿™ä¸ªæ¶æ„æ—¢ä¿æŒäº†æ¸…æ™°çš„ä»£ç ç»„ç»‡ï¼Œåˆæä¾›äº†è¶³å¤Ÿçš„çµæ´»æ€§æ¥åº”å¯¹æœªæ¥æ¶ˆæ¯ç±»å‹çš„æ‰©å±•ï¼
